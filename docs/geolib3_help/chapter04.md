# IV.	地学ライブラリツールの機能

メニューおよびツールバー
地学ライブラリツールのメニューまたはツールバーから以下の各機能を使用することができます。

	プロジェクトツール
	新規プロジェクト：プロジェクトファイルおよびレイヤデータ格納フォルダを作成します。
	プロジェクトを開く：既存のプロジェクトを開きます。
	レイヤーツール
	レイヤーグループ作成：新たに「シナリオマップ」または「主題図」を作成するためのレイヤを生成します。
	シナリオコンテンツ編集：シナリオマップにリンクするコンテンツ（説明ファイル）を作成・管理します。
	GeoClinoデータインポート：Geoclino for iPhoneで収集したデータを主題図レイヤにインポートします。
	編集ツール
	レイヤ保存：選択しているレイヤの地物のスタイル表示を最新化します。
	属性編集：選択している地物の属性を編集します。
	地物の追加：ONにすると、選択しているレイヤの地物追加モードにします。
	地物の移動：ONにすると、選択しているレイヤの地物移動モードにします。
	ノード編集：ONにすると、選択しているレイヤのノード編集モードにします。
	地物の分割：ONにすると、選択しているレイヤの地物分割モードにします。
	地物の結合：複数の地物を一つに結合します。
	地物の削除：選択している地物を削除します。
	走向線描画：選択した走向・傾斜をもとに走向線を描画します。
	地物のコピー：選択した地物をクリップボードにコピーします。
	地物の貼り付け：クリップボードにある地物を選択しているレイヤに貼り付けます。
	Webライブラリにエクスポート：QGISで作成したマップデータをWebライブラリへエクスポートします。
	設定	：各種設定ダイアログを表示します。
	ヘルプ：このファイルを表示します。


プロジェクトツール
[新規プロジェクト]
地学ライブラリ用のプロジェクトファイルおよびフォルダを作成します。
標準メニューの[プロジェクト]-[新規]からプロジェクトファイルを作成すると、地学ライブラリ用フォルダ等が作成されませんので、「地学ライブラリ」用の地図を作成する場合は、必ず本メニューからプロジェクトを作成してください。
①	メニューまたはツールバーで、[プロジェクトツール]-[新規プロジェクト]をクリックします。

⇩ 新規プロジェクト作成ダイアログが表示されます。
②	以下の項目を入力して[作成]をクリックします。

●プロジェクトフォルダ：ここで指定したフォルダの配下に、必要な各種ファイルが作成されます。
●プロジェクトファイル名：プロジェクト定義ファイル（拡張子：.qgsのファイル）名称です。拡張子は付けずに指定します。
●タイトル：プロジェクトを開いているときにQGISのヘッダに表示される名称です。わかりやすい名称を指定してください。
●背景地図：背景となる地図には、国土地理院が配信している電子地図を使用しています。通常は「GSI Map(Standard)」を選択してください。
　※背景地図はインターネットに接続した状態でないと使用できません。
●プロジェクトCRS：通常は「EPSG4326（WGS 84）」を選択してください。

地学ライブラリプラグインでは、座標系（CRS）はWGS84（EPSG:4326）またはJGD2000（EPSG4612）を使用します。地理院地図を読み込んだ際にCRSが変わってしまった場合など、プロジェクト既定の座標系を変更するには、プロジェクトプロパティを開いて変更してください。


⇩ 地学ライブラリ作成用の各種レイヤグループが作成され、レイヤパネルに表示されます。また、プロジェクトフォルダにプロジェクト定義ファイルレイヤーデータを格納するサブフォルダが作成されます。



[プロジェクトを開く...]
既に作成しているプロジェクトファイルを呼び出します。（標準メニューの[プロジェクト]-[開く...] と同機能です）
①	[プロジェクトツール]-[プロジェクトを開く...]をクリックします。

⇩ ファイル選択ダイアログが表示されます。
②	プロジェクトファイル（拡張子：.qgs）を選択して、[開く] をクリックします。

⇩ レイヤがロードされ、レイヤパネルに表示されます。


 レイヤーツール
[レイヤーグループ作成]
シナリオまたは主題図を作成するためのレイヤを作成します。
①	[レイヤーツール]-[レイヤーグループ作成] をクリックします。

⇩ レイヤグループの作成ダイアログが表示されます。
②	レイヤーの種類とグループ名およびGeoPackage（レイヤーデータ）名を入力して[作成]ボタンをクリックします。


⇩ レイヤグループとレイヤが作成され、レイヤパネルに表示されます。

レイヤー種類は「Scenario Map」と「Geological Map」の２種類です。
　「Scenario Map」を選択すると、「Scenario」グループ内に新たなグループを作成し、シナリオマップ属性を持った３つのレイヤ（point(点図形)、line（線図形）、polygon（面図形））が作成されます。
　「Subject Map」を選択すると「Subject」グループ内に新たなグループを作成し、地質図属性を持った４つのレイヤ（pnt（観測地点）、strdip（走向・傾斜測定点）、geo_L（境界線）、geo_A（地質面））が作成されます。

 [シナリオコンテンツ編集]
シナリオにリンクするコンテンツ（HTML文書）のフォルダ内容の閲覧とコンテンツ内容の編集を行います。
①	 [レイヤーツール(Layer Tool)]-[シナリオコンテンツ編集(Edit Scenario Contents)]をクリックします。

⇩ シナリオコンテンツ編集ダイアログが表示されます。
②	コンテンツを新規に作成するには、[テンプレートから作成]欄にファイル名（半角英数のみ）を入力して[作成] をクリックします。
③	コンテンツの編集を行うには、ファイルリストでHTMLファイルを選択して[編集]をクリックします。


⇩ コマンドプロンプト画面が表示されます。

⇩ しばらくすると、オプションで指定したHTMLエディタが起動します。

④	HTMLエディタで、コンテンツを編集し、上書き保存します。

HTMLファイルは、必ずプロジェクトフォルダ配下の「Scenario\html」内に格納してください。
また、HTML内に表示する画像などのファイルも、htmlフォルダより下層のフォルダ内に格納するようにしてください。
HTMLの格納パスは、「シナリオコンテンツ編集ダイアログ」のプロジェクトパス欄に表示されています。


サブフォルダや画像ファイルの作成・編集・削除はシナリオ編集ダイアログでは行えません。このような場合はは、[フォルダ表示]をクリックしてエクスプローラを表示し、エクスプローラの機能にて行ってください。



[GeoClinoデータのインポート]
GeoClinoの観測データ（XMLファイル）をGeological Mapのstrdipレイヤにインポートします。
①	[レイヤーツール(Layer Tool)]-[GeoClinoデータのインポート(Import Geoclino Data)]をクリックします。

⇩ GeoClinoデータのインポートダイアログが表示されます。
②	[ ... ]をクリックして、GeoClinoデータが格納されているXMLファイルを指定します。

③	インポート先レイヤを選択して[インポート]をクリックします。
⇩ 指定したstrdip(走向・傾斜)レイヤにGeoClonoデータがインポートされます。


 編集ツール
編集ツールで、各地図キャンバスの地物の追加・編集を行ないます。
レイヤパネルで編集を行いたいレイヤを選択したうえで、ツールバーの各ボタンをクリックして地物の編集を行います。
ツールバーの操作と機能

①	レイヤ保存：選択しているレイヤの地物のスタイル表示を最新化します。
②	属性編集：地物を選択してこのボタンをクリックすると、選択した図形の属性を編集するダイアログが表示されます。
③	地物の追加：このボタンがONのとき、地図キャンバスをクリックすると新たな図形が追加されます。（ラインやポリゴンの場合は、左クリックを連続して線を描画して、右クリックで終了します）
④	地物の移動：このボタンがONのときは、図形を選択して一括で移動が行えます。
⑤	ノード編集：このボタンがONときは、図形の頂点を選択して移動させることにより、図形の変形が行えます。
⑥	地物の分割：このボタンがONのとき、地図キャンバスで線を引くと、その線の両側で図形が分割されます。
⑦	地物の結合：2つ以上の図形を選択した状態でこのボタンをクリックすると、その図形が結合されます。同じ性質を持つ図形の属性を一致させるときに使用します。
⑧	地物の削除：選択している地物を削除します。複数の地物を選択して一括で削除することができます。
⑨	走向線描画：観測地点の走向・傾斜データをもとに地質境界線を描画する際に、補助走向線を表示することができます。走向・傾斜データを一つ選択した状態で[走向線の描画]をクリックすると、走向線が表示されます。もういちどこのボタンをクリックすると、走向線は消えます。（走向線の本数や間隔、色などは、[設定(Settings)]の「地質図設定で」変更することができます）
⑩	地物のコピー：選択した地物をクリップボードにコピーします。
⑪	地物の貼り付け：クリップボードにある地物を別のレイヤ（同じ種類のレイヤのみ）に貼り付けます。


編集ツールバーを使用した地物の作成・編集方法

【地物を追加する】
①	レイヤパネルで地物を選択するレイヤを選択します。

⇩ 編集ツールバーの[地物の追加]ボタンが使用可能になります。
②	「編集ツールバー」の[地物の追加]ボタンをクリックして、地物追加モードをONの状態にします。
⇩ 地図キャンバスでの操作が地物追加モードになります。
③	地図キャンバス上で追加したい地点をクリックすると、地物が追加されます。
 　 　
ラインやポリゴンを描画する場合は、左クリックしてラインやポリゴンの中間ノードを追加していき、終端で右クリックします。
④	[地物の追加]ボタンをもう一度クリックしてOFFにすると、地物の選択モードに戻ります。

【地物の属性を編集する】
①	地物の選択モードの状態で、編集したい地点の地物をクリックまたは範囲指定して選択します。
⇩ 編集ツールバーの[属性編集]ボタンが使用可能になります。
②	 [属性編集]ボタンをクリックします。
⇩ 地物編集ダイアログが表示されます。
③	「属性編集」ダイアログで各属性を入力して [OK]ボタンをクリックします。
※レイヤによって、属性の内容が異なります。
 　 　

④	地図キャンバスの地物が、指定したシンボルになっていることを確認します。
 　 　

【凡例（スタイル）を追加・変更するには】
現在選択しているレイヤで使用している凡例（スタイル）は、レイヤのプロパティまたはレイヤスタイルパネルで表示されます。
新しい凡例を追加したり、スタイルを変更する場合は、このレイヤプロパティまたはレイヤスタイルパネルを使用して以下のように行います。
＜スタイルを変更する＞
①	レイヤパネルで右上の（レイヤスタイルドックを開く）をクリックして、レイヤスタイルを表示します。
②	レイヤパネルでスタイルを変更したいレイヤを選択します。

⇩ レイヤスタイルが表示されます。
③	変更するシンボルをダブルクリックします。

⇩ シンボルセレクタに画面が切り替わります。
④	シンボルレイヤ（下の図の例では「SVGマーカー」）をクリックします。
⑤	シンボルレイヤタイプを選択し、大きさや色など必要なプロパティを設定します。
Web地学ライブラリで使用できるシンボルレイヤタイプは以下のいずれかです。
ポイント：SVGマーカー または シンプルマーカー（円のみ）
ライン：シンプルライン
ポリゴン：シンプル塗りつぶし
⑥	シンボルレイヤタイプが「SVGマーカー」の場合は、SVGイメージを選択します。
地学ライブラリツールプラグインのデフォルトで使用しているSVGイメージを使用するには、SVGグループで「geolib」を選択します。
⑦	[Apply（適用）]をクリックすると、シンボルの変更が適用されます。


※走向・傾斜のようにシンボルの「回転」を行う場合は、レイヤスタイルパネルの[回転]のプロパティで回転角が格納されているフィールド（以下の例の場合は「strike_value」）を指定します。


＜スタイルを追加する＞
①	レイヤスタイルパネルで下のほうにある [+]ボタンをクリックします。

⇩ シンボルリストの一番下に新たなシンボルが追加されます。
②	追加されたシンボルの値（検索キーになります）と凡例を入力します。


③	追加されたシンボルをダブルクリックして形状や色を変更します。

【走向線を表示する】
地層の境界を描画する際に、以下の手順で走向・傾斜データの測定点からの走向線を表示することができます。
①	レイヤパネルで「strdip(走向・傾斜)」レイヤを選択します。
②	走向線を引くもととなる走向・傾斜データ（地物）を選択します。
 ⇩ 編集ツールバーの「走向線を描画」ボタンが使用可能になります。
③	「編集ツールバー」の [走向線を描画]ボタン をクリックすると、地図キャンバスに走向線が表示されます。
 　　
（既定では、赤線は走向・傾斜測定地点と同高度、橙色は高高度、水色は低高度で10mごとに（補助線は5mごと）に描画しています。走向線の表示高度の間隔や色などの設定は、メニュー[地学ライブラリツール]-[設定]の「地質図設定」タブを開いて変更することができます。
描画された走向線は、以下の④の操作を行わない限り表示は消えませんので、走向線を描画した状態で「地質境界線」を引くことができます。
④	走向線を消去するには、「走向・傾斜」レイヤを選択したのち、[走向線を描画]ボタン をクリックしてOFFにします。

【描画した地物の修正・削除を行う】
地物の追加・編集を繰り返して地図を作成していきますが、誤って描画した地物を削除したり、一度描画した地物を修正したりする必要があります。
そのような場合は、「編集ツールバー」の以下の機能を使用します。
＜地物の一部（ノード）を移動する＞
ポリゴンの形を変えたり、ラインの位置を修正する場合は、以下のように「ノードの修正」で行います。
①	「編集ツールバー」の [ノード編集]ボタン をクリックします。
地図キャンバスで修正したい地物を選択します。
⇩その地物に属する頂点（ノード）が赤い□(または●)で表示されます。

　　
②	変形したい頂点（ノード）をクリックします。
⇩選択した頂点が別の色・形（大きい●など）に変わります。

③	選択した頂点をマウスでドラッグ＆ドロップします

⇩ ドロップした場所に頂点が移動します。

④	修正が完了したら、[ノードの修正]ボタンをもう一度クリックすると修正が保存されます。

※頂点の中間点にマウスを移動すると×が表示されます。ここをクリックすると頂点を追加することができます。

ポリゴン（地層面等）の境界をライン（地層境界線等）と一致させるには
地層面などのポリゴンを描画する際、その境界を地層境界線などのラインと一致させるには以下のように「スナップ」機能を有効したうえで、以下の要領で描画します。
①	ポリゴンの線分上でマウスをダブルクリックして頂点（ノード）を作成します。

②	頂点（ノード）上で左ボタンを押下したまま、境界線に沿ってマウスを移動します。


③	境界線の頂点が近づくと、移動中の頂点が自動的に吸着します。


④	マウスの左ボタンを離すと、境界線の頂点上に地質面の頂点がスナップされます。


【地物を削除する】
地物を削除する場合は、以下のように行います。
①	削除する地物を選択します。

②	「編集ツールバー」の [地物の削除]ボタンをクリックします。
⇩ 地物が削除されます。



【地物を分割する】
境界線や地層面を複数の地物に分割する場合は、以下のように行います。
①	「編集パネル」の[地物の分割]ボタンをクリックします。

⇩ 地図キャンバス上でマウスカーソルが変わります。
②	地図キャンバスで、分割する地物を切るようにマウスでラインを引きます。

⇩ ラインの両側で地物が分割されます。


【地物を結合する】
同じ属性も持つ地物同士をを結合する（一つの地物にする）場合は、以下のように行います。
①	結合する地物（２つ以上）を選択します。


②	「編集ツールバー」の [地物の結合]ボタン をクリックします。

⇩ 「地物の結合」ダイアログが表示されます。
③	通常はこのまま [OK]ボタン をクリックします。

④	２つの地物が１つに結合されます。

 [地学ライブラリにエクスポート]
地学ライブラリツールプラグインを使用して作成したシナリオレイヤおよび地質図レイヤのデータを「Web地学ライブラリ」のデータベースにエクスポートすることができます。
Web地学ライブラリにアップロードを行うには、Web地学ライブラリの利用者ID（メールアドレス）およびパスワードが必要です。
Web地学ライブラリサーバーに接続する
まず、以下の手順でWeb地学ライブラリサーバーに接続します。
※接続がうまくいかない場合は、地学ライブラリメニューの[設定]で設定ダイアログを開き、「地学ライブラリ設定」タブでサーバー情報を確認してください。
①	[Webライブラリにエクスポート]ボタンをクリックします。
⇩ 「Webライブラリにエクスポート」ダイアログが表示されます。

②	[接続]ボタンをクリックします。
⇩ 既に登録済のライブラリ一覧が表示されます。


ライブラリを登録・編集する
ライブラリの登録・編集は以下の手順で行います。

①	ライブラリを新規登録する場合は[新規ライブラリ]ボタンをクリックします。
既存のライブラリを編集するときは、編集したいライブラリ行をダブルクリックします。

⇩ライブラリ情報入力項目が表示されます。

②	ライブラリ情報を入力して、[保存]ボタンをクリックします。

⇩ 保存が完了すると、メッセージが表示されます。


マップデータを登録・編集する
ライブラリに表示するマップデータの登録およびアップロードは以下の手順で行います。
①	マップデータの登録・編集を行うライブラリをダブルクリックします。

⇩現在登録されているマップデータが表示されます。

【シンボルアイコンおよびシナリオファイルをアップロードする】
まず、各種マップで使用しているSVGアイコンおよびシナリオファイル（HTMLおよびリンクしている画像ファイルなど）をサーバーにアップロードします。
②	アップロードを行うファイルの種類にチェックをして、[チェックしたファイルをアップロード]ボタンをクリックします。

⇩アップロードが完了すると、メッセージが表示されます。

※同名のファイルが既にサーバーに存在する場合は、上書きされます。

【マップデータをアップロードする】
続いて、QGISで作成した各種マップデータをサーバーにアップロードします。
③	マップを新規登録する場合は[新規マップ登録]ボタンをクリックします。既存のマップを編集するときは、編集したいマップ行をダブルクリックします。

⇩「マップにエクスポート」ダイアログが表示されます。

④	マップ情報を入力して、[保存]ボタンをクリックします。


マップの種類により、QGISで作成したプロジェクトのレイヤ構造に合わせて保存できるレイヤが変わります。
保存先フォルダの右の欄にレイヤーを指定すると、サーバーのレイヤーファイルがQGISで作成したレイヤーの情報で上書きされます。
⇩保存が完了すると、メッセージが表示されます。


※マップの種類が「Associated」の場合は、下図のようにここで表示したいオープンデータのURLを指定します。
現在、Associatedのマップに使用できるのはXYZタイル形式で提供されているオープンデータのみです。



プラグイン設定
このプラグインの各種設定を行います。

①	[設定]ボタンをクリックします。
⇩ 地学ライブラリツール設定ダイアログが表示されます。
②	以下の各設定を行い[OK]をクリックします。

「プロジェクト設定」タブ
HTMLエディタ：シナリオコンテンツのHTMK文書を編集するソフトウエアの実行パスを指定します。


「地質図設定」タブ
走向線の等高間隔、線の長さ、線の数、線の太さ、線の色（基準、高位、低位）を設定します。


「地学ライブラリ設定」タブ
地学ライブラリサーバーの接続情報を設定します。パスワードは、Web地学ライブラリにログインしてユーザ情報を表示し、そこに記載されているパスワードを指定してください。

ヘルプ
このファイルを表示します。

